# The Accountant

The accountant is a service that keeps track of transactions between wallets.
Each wallet has its own independent history of transactions. There is a set of rules allowing for transactions to happen.
The accountant is not keeping track of all transactions in a single blockchain but rather allows to keep transactions signed by an authority. A signed transaction is valid transaction only if the issuer and receiver of the transaction are existing within the system.

## Execute the server

0. Run database `docker compose up`.
1. Build the server `go build -o path/to/bin/central cmd/central/main.go`.
2. Create `server_settings.yaml` according to `server_settings_example.yaml` file in `path/to/bin/` folder.
3. Run `./path/to/bin/central`.

## Run for development

0. Run database `docker compose up`.
1. Create `server_settings.yaml` according to `server_settings_example.yaml` in the repo root folder.
2. Run `make run` or `go run cmd/central/main.go`.
<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# block

```go
import "github.com/bartossh/The-Accountant/block"
```

## Index

- [type Block](<#type-block>)
  - [func NewBlock(difficulty, next uint64, prevHash [32]byte, trxHashes [][32]byte) Block](<#func-newblock>)
  - [func (b *Block) Validate(trxHashes [][32]byte) bool](<#func-block-validate>)


## type [Block](<https://github.com/bartossh/The-Accountant/blob/main/block/block.go#L17-L26>)

Block holds block information.

```go
type Block struct {
    ID         primitive.ObjectID `json:"-"          bson:"_id"`
    Index      uint64             `json:"index"      bson:"index"`
    Timestamp  uint64             `json:"timestamp"  bson:"timestamp"`
    Nonce      uint64             `json:"nonce"      bson:"nonce"`
    Difficulty uint64             `json:"difficulty" bson:"difficulty"`
    Hash       [32]byte           `json:"hash"       bson:"hash"`
    PrevHash   [32]byte           `json:"prev_hash"  bson:"prev_hash"`
    TrxHashes  [][32]byte         `json:"trx_hashes" bson:"trx_hashes"`
}
```

### func [NewBlock](<https://github.com/bartossh/The-Accountant/blob/main/block/block.go#L32>)

```go
func NewBlock(difficulty, next uint64, prevHash [32]byte, trxHashes [][32]byte) Block
```

NewBlock creates a new Block hashing it with given difficulty. Higher difficulty requires more computations to happen to find possible target hash. Difficulty is stored inside the Block and is a part of a hashed data. Transactions hashes are prehashed before calculating the Block hash with merkle tree.

### func \(\*Block\) [Validate](<https://github.com/bartossh/The-Accountant/blob/main/block/block.go#L57>)

```go
func (b *Block) Validate(trxHashes [][32]byte) bool
```

Validate validates the Block. Validations goes in the same order like Block hashing algorithm, just the proof of work part is not required as Nonce is already known.

# blockchain

```go
import "github.com/bartossh/The-Accountant/blockchain"
```

## Index

- [Variables](<#variables>)
- [func GenesisBlock(ctx context.Context, rw BlockReadWriter) error](<#func-genesisblock>)
- [type BlockReadWriter](<#type-blockreadwriter>)
- [type BlockReader](<#type-blockreader>)
- [type BlockWriter](<#type-blockwriter>)
- [type Blockchain](<#type-blockchain>)
  - [func NewBlockchain(ctx context.Context, rw BlockReadWriter) (*Blockchain, error)](<#func-newblockchain>)
  - [func (c *Blockchain) LastBlockHashIndex() ([32]byte, uint64)](<#func-blockchain-lastblockhashindex>)
  - [func (c *Blockchain) ReadBlocksFromIndex(ctx context.Context, idx uint64) ([]block.Block, error)](<#func-blockchain-readblocksfromindex>)
  - [func (c *Blockchain) ReadLastNBlocks(ctx context.Context, n int) ([]block.Block, error)](<#func-blockchain-readlastnblocks>)
  - [func (c *Blockchain) WriteBlock(ctx context.Context, block block.Block) error](<#func-blockchain-writeblock>)


## Variables

```go
var (
    ErrBlockNotFound        = errors.New("block not found")
    ErrInvalidBlockPrevHash = errors.New("block prev hash is invalid")
    ErrInvalidBlockHash     = errors.New("block hash is invalid")
    ErrInvalidBlockIndex    = errors.New("block index is invalid")
)
```

## func [GenesisBlock](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L45>)

```go
func GenesisBlock(ctx context.Context, rw BlockReadWriter) error
```

GenesisBlock creates a genesis block.

## type [BlockReadWriter](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L31-L34>)

BlockReadWriter is the interface that groups the basic Read and Write methods.

```go
type BlockReadWriter interface {
    BlockReader
    BlockWriter
}
```

## type [BlockReader](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L20-L23>)

blockReader is the interface that wraps the basic Read methods.

```go
type BlockReader interface {
    LastBlock(ctx context.Context) (block.Block, error)
    ReadBlockByHash(ctx context.Context, hash [32]byte) (block.Block, error)
}
```

## type [BlockWriter](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L26-L28>)

BlockWriter is the interface that wraps the basic Write method.

```go
type BlockWriter interface {
    WriteBlock(ctx context.Context, block block.Block) error
}
```

## type [Blockchain](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L37-L42>)

Blockchain keeps track of the blocks.

```go
type Blockchain struct {
    // contains filtered or unexported fields
}
```

### func [NewBlockchain](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L55>)

```go
func NewBlockchain(ctx context.Context, rw BlockReadWriter) (*Blockchain, error)
```

NewBlockchain creates a new Blockchain that has access to the blockchain stored in the repository.

### func \(\*Blockchain\) [LastBlockHashIndex](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L70>)

```go
func (c *Blockchain) LastBlockHashIndex() ([32]byte, uint64)
```

LastBlockHashIndex returns last block hash and index.

### func \(\*Blockchain\) [ReadBlocksFromIndex](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L97>)

```go
func (c *Blockchain) ReadBlocksFromIndex(ctx context.Context, idx uint64) ([]block.Block, error)
```

ReadBlocksFromIndex reads all blocks from given index till the current block.

### func \(\*Blockchain\) [ReadLastNBlocks](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L77>)

```go
func (c *Blockchain) ReadLastNBlocks(ctx context.Context, n int) ([]block.Block, error)
```

ReadLastNBlocks reads the last n blocks.

### func \(\*Blockchain\) [WriteBlock](<https://github.com/bartossh/The-Accountant/blob/main/blockchain/blockchain.go#L121>)

```go
func (c *Blockchain) WriteBlock(ctx context.Context, block block.Block) error
```

WriteBlock writes block in to the blockchain repository.

# bookkeeping

```go
import "github.com/bartossh/The-Accountant/bookkeeping"
```

## Index

- [Variables](<#variables>)
- [type AddressChecker](<#type-addresschecker>)
- [type BlockFinder](<#type-blockfinder>)
- [type BlockReadWriter](<#type-blockreadwriter>)
- [type BlockReader](<#type-blockreader>)
- [type BlockWriter](<#type-blockwriter>)
- [type Config](<#type-config>)
  - [func (c Config) Validate() error](<#func-config-validate>)
- [type Ledger](<#type-ledger>)
  - [func NewLedger(config Config, bc BlockReadWriter, tx TrxWriteReadMover, ac AddressChecker, vr SignatureVerifier, tf BlockFinder) (*Ledger, error)](<#func-newledger>)
  - [func (l *Ledger) ReadAwaitedTransactionsForAddress(ctx context.Context, message, signature []byte, hash [32]byte, address string) ([]transaction.Transaction, error)](<#func-ledger-readawaitedtransactionsforaddress>)
  - [func (l *Ledger) Run(ctx context.Context)](<#func-ledger-run>)
  - [func (l *Ledger) VerifySignature(message, signature []byte, hash [32]byte, address string) error](<#func-ledger-verifysignature>)
  - [func (l *Ledger) WriteCandidateTransaction(ctx context.Context, trx *transaction.Transaction) error](<#func-ledger-writecandidatetransaction>)
  - [func (l *Ledger) WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error](<#func-ledger-writeissuersignedtransactionforreceiver>)
- [type SignatureVerifier](<#type-signatureverifier>)
- [type TrxWriteReadMover](<#type-trxwritereadmover>)


## Variables

```go
var (
    ErrTrxExistsInTheLadger            = errors.New("transaction is already in the ledger")
    ErrTrxExistsInTheBlockchain        = errors.New("transaction is already in the blockchain")
    ErrAddressNotExists                = errors.New("address does not exist in the addresses repository")
    ErrBlockTxsCorrupted               = errors.New("all transaction failed, block corrupted")
    ErrDifficultyNotInRange            = errors.New("invalid difficulty, difficulty can by in range [1 : 255]")
    ErrBlockWriteTimestampNoInRange    = errors.New("block write timestamp is not in range of [one second : four hours]")
    ErrBlockTransactionsSizeNotInRange = errors.New("block transactions size is not in range of [1 : 60000]")
)
```

## type [AddressChecker](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L54-L56>)

```go
type AddressChecker interface {
    CheckAddressExists(ctx context.Context, address string) (bool, error)
}
```

## type [BlockFinder](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L62-L65>)

```go
type BlockFinder interface {
    WriteTransactionsInBlock(ctx context.Context, blockHash [32]byte, trxHash [][32]byte) error
    FindTransactionInBlockHash(ctx context.Context, trxHash [32]byte) ([32]byte, error)
}
```

## type [BlockReadWriter](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L49-L52>)

```go
type BlockReadWriter interface {
    BlockReader
    BlockWriter
}
```

## type [BlockReader](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L41-L43>)

```go
type BlockReader interface {
    LastBlockHashIndex() ([32]byte, uint64)
}
```

## type [BlockWriter](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L45-L47>)

```go
type BlockWriter interface {
    WriteBlock(ctx context.Context, block block.Block) error
}
```

## type [Config](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L67-L71>)

```go
type Config struct {
    Difficulty            uint64 `json:"difficulty"              bson:"difficulty"              yaml:"difficulty"`
    BlockWriteTimestamp   uint64 `json:"block_write_timestamp"   bson:"block_write_timestamp"   yaml:"block_write_timestamp"`
    BlockTransactionsSize int    `json:"block_transactions_size" bson:"block_transactions_size" yaml:"block_transactions_size"`
}
```

### func \(Config\) [Validate](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L73>)

```go
func (c Config) Validate() error
```

## type [Ledger](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L91-L100>)

Ledger is a collection of ledger functionality to perform bookkeeping.

```go
type Ledger struct {
    // contains filtered or unexported fields
}
```

### func [NewLedger](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L103-L110>)

```go
func NewLedger(config Config, bc BlockReadWriter, tx TrxWriteReadMover, ac AddressChecker, vr SignatureVerifier, tf BlockFinder) (*Ledger, error)
```

NewLedger creates new Ledger if config is valid or returns error otherwise.

### func \(\*Ledger\) [ReadAwaitedTransactionsForAddress](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L189-L194>)

```go
func (l *Ledger) ReadAwaitedTransactionsForAddress(ctx context.Context, message, signature []byte, hash [32]byte, address string) ([]transaction.Transaction, error)
```

### func \(\*Ledger\) [Run](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L128>)

```go
func (l *Ledger) Run(ctx context.Context)
```

Run runs the Ladger engine that writes blocks to the blockchain repository. Run starts a goroutine and can be stopped by cancelling the context.

### func \(\*Ledger\) [VerifySignature](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L207>)

```go
func (l *Ledger) VerifySignature(message, signature []byte, hash [32]byte, address string) error
```

### func \(\*Ledger\) [WriteCandidateTransaction](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L172>)

```go
func (l *Ledger) WriteCandidateTransaction(ctx context.Context, trx *transaction.Transaction) error
```

WriteCandidateTransaction validates and writes a transaction to the repository. Transaction is not yet a part of the blockchain.

### func \(\*Ledger\) [WriteIssuerSignedTransactionForReceiver](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L154-L158>)

```go
func (l *Ledger) WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error
```

WriteIssuerSignedTransactionForReceiver validates issuer signature and writes a transaction to the repository for receiver.

## type [SignatureVerifier](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L58-L60>)

```go
type SignatureVerifier interface {
    Verify(message, signature []byte, hash [32]byte, address string) error
}
```

## type [TrxWriteReadMover](<https://github.com/bartossh/The-Accountant/blob/main/bookkeeping/bookkeeping.go#L33-L39>)

```go
type TrxWriteReadMover interface {
    WriteTemporaryTransaction(ctx context.Context, trx *transaction.Transaction) error
    WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error
    MoveTransactionsFromTemporaryToPermanent(ctx context.Context, hash [][32]byte) error
    RemoveAwaitingTransaction(ctx context.Context, trxHash [32]byte) error
    ReadAwaitingTransactions(ctx context.Context, address string) ([]transaction.Transaction, error)
}
```

# client

```go
import "github.com/bartossh/The-Accountant/client"
```

## Index

- [Variables](<#variables>)
- [type Rest](<#type-rest>)
  - [func NewRest(apiRoot string, timeout time.Duration) *Rest](<#func-newrest>)
  - [func (r *Rest) DataToSign(address string) (server.DataToSignResponse, error)](<#func-rest-datatosign>)
  - [func (r *Rest) ValidateApiVersion() error](<#func-rest-validateapiversion>)


## Variables

```go
var (
    ErrApiVersionMismatch = fmt.Errorf("api version mismatch")
    ErrApiHeaderMismatch  = fmt.Errorf("api header mismatch")
)
```

## type [Rest](<https://github.com/bartossh/The-Accountant/blob/main/client/client.go#L20-L23>)

Rest is a rest client for the API.

```go
type Rest struct {
    // contains filtered or unexported fields
}
```

### func [NewRest](<https://github.com/bartossh/The-Accountant/blob/main/client/client.go#L26>)

```go
func NewRest(apiRoot string, timeout time.Duration) *Rest
```

NewRest creates a new rest client.

### func \(\*Rest\) [DataToSign](<https://github.com/bartossh/The-Accountant/blob/main/client/client.go#L115>)

```go
func (r *Rest) DataToSign(address string) (server.DataToSignResponse, error)
```

DataToValidate makes http request to the API server and returns data to validate.

### func \(\*Rest\) [ValidateApiVersion](<https://github.com/bartossh/The-Accountant/blob/main/client/client.go#L97>)

```go
func (r *Rest) ValidateApiVersion() error
```

ValidateApiVersion makes a call to the API server and validates client and server API versions and header correctness.

# configuration

```go
import "github.com/bartossh/The-Accountant/configuration"
```

## Index

- [type Main](<#type-main>)
  - [func Read(path string) (Main, error)](<#func-read>)


## type [Main](<https://github.com/bartossh/The-Accountant/blob/main/configuration/configuration.go#L16-L21>)

Main is the main configuration of the application that corresponds to the \*.yaml file that holds the configuration.

```go
type Main struct {
    Bookkeeper   bookkeeping.Config  `yaml:"bookkeeper"`
    Server       server.Config       `yaml:"server"`
    Database     repo.Config         `yaml:"database"`
    DataProvider dataprovider.Config `yaml:"data_provider"`
}
```

### func [Read](<https://github.com/bartossh/The-Accountant/blob/main/configuration/configuration.go#L24>)

```go
func Read(path string) (Main, error)
```

Read reads the configuration  from the file and returns the MainYaml struct.

# dataprovider

```go
import "github.com/bartossh/The-Accountant/dataprovider"
```

## Index

- [type Cache](<#type-cache>)
  - [func New(ctx context.Context, cfg Config) *Cache](<#func-new>)
  - [func (c *Cache) ProvideData(address string) []byte](<#func-cache-providedata>)
  - [func (c *Cache) ValidateData(address string, data []byte) bool](<#func-cache-validatedata>)
- [type Config](<#type-config>)


## type [Cache](<https://github.com/bartossh/The-Accountant/blob/main/dataprovider/dataprovider.go#L22-L26>)

Cache is a simple in\-memory cache for storing generated data.

```go
type Cache struct {
    // contains filtered or unexported fields
}
```

### func [New](<https://github.com/bartossh/The-Accountant/blob/main/dataprovider/dataprovider.go#L29>)

```go
func New(ctx context.Context, cfg Config) *Cache
```

New creates new Cache and runs the cleaner.

### func \(\*Cache\) [ProvideData](<https://github.com/bartossh/The-Accountant/blob/main/dataprovider/dataprovider.go#L65>)

```go
func (c *Cache) ProvideData(address string) []byte
```

ProvideData generates data and stores it referring to given address.

### func \(\*Cache\) [ValidateData](<https://github.com/bartossh/The-Accountant/blob/main/dataprovider/dataprovider.go#L80>)

```go
func (c *Cache) ValidateData(address string, data []byte) bool
```

ValidateData checks if data is stored for given address and is not expired.

## type [Config](<https://github.com/bartossh/The-Accountant/blob/main/dataprovider/dataprovider.go#L12-L14>)

Config holds configuration for Cache.

```go
type Config struct {
    Longevity uint64 `yaml:"longevity"` // Data longevity in seconds.
}
```

# repo

```go
import "github.com/bartossh/The-Accountant/repo"
```

## Index

- [type Address](<#type-address>)
- [type Config](<#type-config>)
- [type DataBase](<#type-database>)
  - [func Connect(ctx context.Context, cfg Config) (*DataBase, error)](<#func-connect>)
  - [func (db DataBase) CheckAddressExists(ctx context.Context, address string) (bool, error)](<#func-database-checkaddressexists>)
  - [func (db *DataBase) CheckToken(ctx context.Context, token string) (bool, error)](<#func-database-checktoken>)
  - [func (c DataBase) Disconnect(ctx context.Context) error](<#func-database-disconnect>)
  - [func (db DataBase) FindAddress(ctx context.Context, search string, limit int) ([]string, error)](<#func-database-findaddress>)
  - [func (db DataBase) FindTransactionInBlockHash(ctx context.Context, trxHash [32]byte) ([32]byte, error)](<#func-database-findtransactioninblockhash>)
  - [func (db *DataBase) InvalidateToken(ctx context.Context, token string) error](<#func-database-invalidatetoken>)
  - [func (db DataBase) LastBlock(ctx context.Context) (block.Block, error)](<#func-database-lastblock>)
  - [func (db DataBase) MoveTransactionsFromTemporaryToPermanent(ctx context.Context, hash [][32]byte) error](<#func-database-movetransactionsfromtemporarytopermanent>)
  - [func (db DataBase) ReadAwaitingTransactions(ctx context.Context, address string) ([]transaction.Transaction, error)](<#func-database-readawaitingtransactions>)
  - [func (db DataBase) ReadBlockByHash(ctx context.Context, hash [32]byte) (block.Block, error)](<#func-database-readblockbyhash>)
  - [func (db DataBase) RemoveAwaitingTransaction(ctx context.Context, trxHash [32]byte) error](<#func-database-removeawaitingtransaction>)
  - [func (c DataBase) RunMigration(ctx context.Context) error](<#func-database-runmigration>)
  - [func (db DataBase) WriteAddress(ctx context.Context, address string) error](<#func-database-writeaddress>)
  - [func (db DataBase) WriteBlock(ctx context.Context, block block.Block) error](<#func-database-writeblock>)
  - [func (db DataBase) WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error](<#func-database-writeissuersignedtransactionforreceiver>)
  - [func (db DataBase) WriteTemporaryTransaction(ctx context.Context, trx *transaction.Transaction) error](<#func-database-writetemporarytransaction>)
  - [func (db *DataBase) WriteToken(ctx context.Context, token string, expirationDate int64) error](<#func-database-writetoken>)
  - [func (db DataBase) WriteTransactionsInBlock(ctx context.Context, blockHash [32]byte, trxHash [][32]byte) error](<#func-database-writetransactionsinblock>)
- [type Migration](<#type-migration>)
- [type Token](<#type-token>)
- [type TransactionAwaitingReceiver](<#type-transactionawaitingreceiver>)
- [type TransactionInBlock](<#type-transactioninblock>)


## type [Address](<https://github.com/bartossh/The-Accountant/blob/main/repo/address.go#L13-L16>)

Address holds information about unique PublicKey.

```go
type Address struct {
    ID        primitive.ObjectID `json:"-"          bson:"_id,omitempty"`
    PublicKey string             `json:"public_key" bson:"public_key"`
}
```

## type [Config](<https://github.com/bartossh/The-Accountant/blob/main/repo/repo.go#L24-L29>)

Config contains configuration for the database.

```go
type Config struct {
    ConnStr      string `yaml:"conn_str"`         // ConnStr is the connection string to the database.
    DatabaseName string `yaml:"database_name"`    // DatabaseName is the name of the database.
    Token        string `yaml:"token"`            // Token is the token that is used to confirm api clients access.
    TokenExpire  int64  `yaml:"token_expiration"` // TokenExpire is the number of seconds after which token expires.
}
```

## type [DataBase](<https://github.com/bartossh/The-Accountant/blob/main/repo/repo.go#L32-L34>)

Database provides database access for read, write and delete of repository entities.

```go
type DataBase struct {
    // contains filtered or unexported fields
}
```

### func [Connect](<https://github.com/bartossh/The-Accountant/blob/main/repo/repo.go#L37>)

```go
func Connect(ctx context.Context, cfg Config) (*DataBase, error)
```

Connect creates new connection to the repository and returns pointer to the DataBase.

### func \(DataBase\) [CheckAddressExists](<https://github.com/bartossh/The-Accountant/blob/main/repo/address.go#L36>)

```go
func (db DataBase) CheckAddressExists(ctx context.Context, address string) (bool, error)
```

CheckAddressExists checks if address exists in the database. Returns true if exists and error if database error different from ErrNoDocuments.

### func \(\*DataBase\) [CheckToken](<https://github.com/bartossh/The-Accountant/blob/main/repo/token.go#L21>)

```go
func (db *DataBase) CheckToken(ctx context.Context, token string) (bool, error)
```

CheckToken checks if token exists in the database is valid and didn't expire.

### func \(DataBase\) [Disconnect](<https://github.com/bartossh/The-Accountant/blob/main/repo/repo.go#L53>)

```go
func (c DataBase) Disconnect(ctx context.Context) error
```

Disconnect disconnects user from database

### func \(DataBase\) [FindAddress](<https://github.com/bartossh/The-Accountant/blob/main/repo/search.go#L43>)

```go
func (db DataBase) FindAddress(ctx context.Context, search string, limit int) ([]string, error)
```

FindAddress looks for matching address in the addresses repository and returns limited slice of matching addresses. If limit is set to 0 or above the 1000 which is maximum then search is limited to 1000.

### func \(DataBase\) [FindTransactionInBlockHash](<https://github.com/bartossh/The-Accountant/blob/main/repo/search.go#L33>)

```go
func (db DataBase) FindTransactionInBlockHash(ctx context.Context, trxHash [32]byte) ([32]byte, error)
```

FindTransactionInBlockHash finds Block hash in to which Transaction with given hash was added.

### func \(\*DataBase\) [InvalidateToken](<https://github.com/bartossh/The-Accountant/blob/main/repo/token.go#L52>)

```go
func (db *DataBase) InvalidateToken(ctx context.Context, token string) error
```

InvalidateToken invalidates token.

### func \(DataBase\) [LastBlock](<https://github.com/bartossh/The-Accountant/blob/main/repo/block.go#L13>)

```go
func (db DataBase) LastBlock(ctx context.Context) (block.Block, error)
```

LastBlock returns last block from the database.

### func \(DataBase\) [MoveTransactionsFromTemporaryToPermanent](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L64>)

```go
func (db DataBase) MoveTransactionsFromTemporaryToPermanent(ctx context.Context, hash [][32]byte) error
```

MoveTransactionsFromTemporaryToPermanent moves transactions from temporary storage to permanent.

### func \(DataBase\) [ReadAwaitingTransactions](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L49>)

```go
func (db DataBase) ReadAwaitingTransactions(ctx context.Context, address string) ([]transaction.Transaction, error)
```

ReadAwaitingTransactions reads all transactions paired with given address.

### func \(DataBase\) [ReadBlockByHash](<https://github.com/bartossh/The-Accountant/blob/main/repo/block.go#L35>)

```go
func (db DataBase) ReadBlockByHash(ctx context.Context, hash [32]byte) (block.Block, error)
```

ReadBlockByHash returns block with given hash.

### func \(DataBase\) [RemoveAwaitingTransaction](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L28>)

```go
func (db DataBase) RemoveAwaitingTransaction(ctx context.Context, trxHash [32]byte) error
```

RemoveAwaitingTransaction removes transaction from the awaiting transaction storage.

### func \(DataBase\) [RunMigration](<https://github.com/bartossh/The-Accountant/blob/main/repo/migrations.go#L239>)

```go
func (c DataBase) RunMigration(ctx context.Context) error
```

RunMigrationUp runs all the migrations

### func \(DataBase\) [WriteAddress](<https://github.com/bartossh/The-Accountant/blob/main/repo/address.go#L19>)

```go
func (db DataBase) WriteAddress(ctx context.Context, address string) error
```

WriteAddress writes unique address to the database.

### func \(DataBase\) [WriteBlock](<https://github.com/bartossh/The-Accountant/blob/main/repo/block.go#L44>)

```go
func (db DataBase) WriteBlock(ctx context.Context, block block.Block) error
```

WriteBlock writes block to the database.

### func \(DataBase\) [WriteIssuerSignedTransactionForReceiver](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L34-L38>)

```go
func (db DataBase) WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error
```

WriteIssuerSignedTransactionForReceiver writes transaction to the awaiting transaction storage paired with given receiver.

### func \(DataBase\) [WriteTemporaryTransaction](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L22>)

```go
func (db DataBase) WriteTemporaryTransaction(ctx context.Context, trx *transaction.Transaction) error
```

WriteTemporaryTransaction writes transaction to the temporary storage.

### func \(\*DataBase\) [WriteToken](<https://github.com/bartossh/The-Accountant/blob/main/repo/token.go#L39>)

```go
func (db *DataBase) WriteToken(ctx context.Context, token string, expirationDate int64) error
```

WriteToken writes unique token to the database.

### func \(DataBase\) [WriteTransactionsInBlock](<https://github.com/bartossh/The-Accountant/blob/main/repo/search.go#L20>)

```go
func (db DataBase) WriteTransactionsInBlock(ctx context.Context, blockHash [32]byte, trxHash [][32]byte) error
```

WriteTransactionsInBlock stores relation between Transaction and Block to which Transaction was added.

## type [Migration](<https://github.com/bartossh/The-Accountant/blob/main/repo/migrations.go#L24-L26>)

Migration describes migration that is made in the repository database.

```go
type Migration struct {
    Name string `json:"name" bson:"name"`
}
```

## type [Token](<https://github.com/bartossh/The-Accountant/blob/main/repo/token.go#L13-L18>)

Token holds information about unique token.

```go
type Token struct {
    ID             primitive.ObjectID `json:"-" bson:"_id,omitempty"`
    Token          string             `json:"token" bson:"token"`
    Valid          bool               `json:"valid" bson:"valid"`
    ExpirationDate int64              `json:"expiration_date" bson:"expiration_date"`
}
```

## type [TransactionAwaitingReceiver](<https://github.com/bartossh/The-Accountant/blob/main/repo/transaction.go#L14-L19>)

TransactionAwaitingReceiver represents transaction awaiting receiver signature.

```go
type TransactionAwaitingReceiver struct {
    ID              primitive.ObjectID      `json:"-"                bson:"_id,omitempty"`
    ReceiverAddress string                  `json:"receiver_address" bson:"receiver_address"`
    Transaction     transaction.Transaction `json:"transaction"      bson:"transaction"`
    TransactionHash [32]byte                `json:"transaction_hash" bson:"transaction_hash"`
}
```

## type [TransactionInBlock](<https://github.com/bartossh/The-Accountant/blob/main/repo/search.go#L13-L17>)

TransactionInBlock stores relation between Transaction and Block to which Transaction was added. It is stored for fast lookup only.

```go
type TransactionInBlock struct {
    ID              primitive.ObjectID `json:"-" bson:"_id,omitempty"`
    BlockHash       [32]byte           `json:"-" bson:"block_hash"`
    TransactionHash [32]byte           `json:"-" bson:"transaction_hash"`
}
```

# serializer

```go
import "github.com/bartossh/The-Accountant/serializer"
```

## Index

- [func Base58Decode(input []byte) ([]byte, error)](<#func-base58decode>)
- [func Base58Encode(input []byte) []byte](<#func-base58encode>)


## func [Base58Decode](<https://github.com/bartossh/The-Accountant/blob/main/serializer/serializer.go#L13>)

```go
func Base58Decode(input []byte) ([]byte, error)
```

Base58Decode decodes base58 string to byte array.

## func [Base58Encode](<https://github.com/bartossh/The-Accountant/blob/main/serializer/serializer.go#L6>)

```go
func Base58Encode(input []byte) []byte
```

Base58Encode encodes byte array to base58 string.

# server

```go
import "github.com/bartossh/The-Accountant/server"
```

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func Run(ctx context.Context, c Config, repo Repository, bookkeeping Bookkeeper, pv RandomDataProvideValidator) error](<#func-run>)
- [type AliveResponse](<#type-aliveresponse>)
- [type AwaitedTransactionRequest](<#type-awaitedtransactionrequest>)
- [type AwaitedTransactionResponse](<#type-awaitedtransactionresponse>)
- [type Bookkeeper](<#type-bookkeeper>)
- [type Config](<#type-config>)
- [type CreateAddressRequest](<#type-createaddressrequest>)
- [type CreateAddressResponse](<#type-createaddressresponse>)
- [type DataToSignRequest](<#type-datatosignrequest>)
- [type DataToSignResponse](<#type-datatosignresponse>)
- [type Message](<#type-message>)
- [type RandomDataProvideValidator](<#type-randomdataprovidevalidator>)
- [type Repository](<#type-repository>)
- [type SearchAddressRequest](<#type-searchaddressrequest>)
- [type SearchAddressResponse](<#type-searchaddressresponse>)
- [type SearchBlockRequest](<#type-searchblockrequest>)
- [type SearchBlockResponse](<#type-searchblockresponse>)
- [type TransactionConfirmProposeResponse](<#type-transactionconfirmproposeresponse>)
- [type TransactionProposeRequest](<#type-transactionproposerequest>)
- [type UpgradeConnectionRequest](<#type-upgradeconnectionrequest>)


## Constants

```go
const (
    ApiVersion = "1.0.0"
    Header     = "The Accountant"
)
```

```go
const (
    AliveURL              = "/alive"                         // URL to check if server is alive and version.
    SearchAddressURL      = searchGroupURL + addressURL      // URL to search for address.
    SearchBlockURL        = searchGroupURL + blockURL        // URL to search for block that contains transaction hash.
    ProposeTransactionURL = transactionGroupURL + proposeURL // URL to propose transaction signed by the issuer.
    ConfirmTransactionURL = transactionGroupURL + confirmURL // URL to confirm transaction signed by the receiver.
    AwaitedTransactionURL = transactionGroupURL + awaitedURL // URL to get awaited transactions for the receiver.
    DataToValidateURL     = validatorGroupURL + dataURL      // URL to get data to validate address by signing rew message.
    WsURL                 = "/ws"                            // URL to connect to websocket.
)
```

## Variables

```go
var ErrWrongPortSpecified = errors.New("port must be between 1 and 65535")
```

## func [Run](<https://github.com/bartossh/The-Accountant/blob/main/server/server.go#L95>)

```go
func Run(ctx context.Context, c Config, repo Repository, bookkeeping Bookkeeper, pv RandomDataProvideValidator) error
```

Run initializes routing and runs the server. To stop the server cancel the context.

## type [AliveResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L9-L13>)

AliveResponse is a response for alive and version check.

```go
type AliveResponse struct {
    Alive      bool   `json:"alive"`
    APIVersion string `json:"api_version"`
    APIHeader  string `json:"api_header"`
}
```

## type [AwaitedTransactionRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L138-L143>)

AwaitedTransactionRequest is a request to get awaited transactions for given address. Request contains of Address for which Awaited Transactions are requested, Data in binary format, Hash of Data and Signature of the Data to prove that entity doing the request is an Address owner.

```go
type AwaitedTransactionRequest struct {
    Address   string   `json:"address"`
    Data      []byte   `json:"data"`
    Hash      [32]byte `json:"hash"`
    Signature []byte   `json:"signature"`
}
```

## type [AwaitedTransactionResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L146-L149>)

AwaitedTransactionResponse is a response for awaited transactions request.

```go
type AwaitedTransactionResponse struct {
    Success             bool                      `json:"success"`
    AwaitedTransactions []transaction.Transaction `json:"awaited_transactions"`
}
```

## type [Bookkeeper](<https://github.com/bartossh/The-Accountant/blob/main/server/server.go#L62-L73>)

Bookkeeper abstracts methods of the bookkeeping of a blockchain.

```go
type Bookkeeper interface {
    Run(ctx context.Context)
    WriteCandidateTransaction(ctx context.Context, tx *transaction.Transaction) error
    WriteIssuerSignedTransactionForReceiver(ctx context.Context, receiverAddr string, trx *transaction.Transaction) error
    ReadAwaitedTransactionsForAddress(
        ctx context.Context,
        message, signature []byte,
        hash [32]byte,
        address string,
    ) ([]transaction.Transaction, error)
    VerifySignature(message, signature []byte, hash [32]byte, address string) error
}
```

## type [Config](<https://github.com/bartossh/The-Accountant/blob/main/server/server.go#L83-L85>)

Config contains configuration of the server.

```go
type Config struct {
    Port int `yaml:"port"`
}
```

## type [CreateAddressRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L200-L206>)

CreateAddressRequest is a request to create an address.

```go
type CreateAddressRequest struct {
    Address   string   `json:"address"`
    Token     string   `json:"token"`
    Data      []byte   `json:"data"`
    Hash      [32]byte `json:"hash"`
    Signature []byte   `json:"signature"`
}
```

## type [CreateAddressResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L209-L212>)

Response for address creation.

```go
type CreateAddressResponse struct {
    Success bool   `json:"success"`
    Address string `json:"address"`
}
```

## type [DataToSignRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L181-L183>)

DataToSignRequest is a request to get data to sign for proving identity.

```go
type DataToSignRequest struct {
    Address string `json:"address"`
}
```

## type [DataToSignResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L186-L188>)

DataToSignRequest is a response containing data to sign for proving identity.

```go
type DataToSignResponse struct {
    Data []byte `json:"message"`
}
```

## type [Message](<https://github.com/bartossh/The-Accountant/blob/main/server/ws.go#L43-L48>)

Message is the message that is used to exchange information between the server and the client.

```go
type Message struct {
    Command string `json:"command"` // Command is the command that refers to the action handler in websocket protocol.
    Error   string `json:"error"`   // Error is the error message that is sent to the client.
    Data    []byte `json:"data"`    // Data is compressed data that is sent to the client. Based on the command, the client will know how to decompress the data.
    // contains filtered or unexported fields
}
```

## type [RandomDataProvideValidator](<https://github.com/bartossh/The-Accountant/blob/main/server/server.go#L77-L80>)

RandomDataProvideValidator provides random binary data for signing to prove identity and the validator of data being valid and not expired.

```go
type RandomDataProvideValidator interface {
    ProvideData(address string) []byte
    ValidateData(address string, data []byte) bool
}
```

## type [Repository](<https://github.com/bartossh/The-Accountant/blob/main/server/server.go#L51-L59>)

Repository is the interface that wraps the basic CRUD and Search methods. Repository should be properly indexed to allow for transaction and block hash. as well as address public keys to be and unique and the hash lookup should be fast. Repository holds the blocks and transaction that are part of the blockchain.

```go
type Repository interface {
    Disconnect(ctx context.Context) error
    RunMigration(ctx context.Context) error
    FindAddress(ctx context.Context, search string, limit int) ([]string, error)
    CheckAddressExists(ctx context.Context, address string) (bool, error)
    WriteAddress(ctx context.Context, address string) error
    FindTransactionInBlockHash(ctx context.Context, trxHash [32]byte) ([32]byte, error)
    CheckToken(ctx context.Context, token string) (bool, error)
}
```

## type [SearchAddressRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L25-L27>)

SearchAddressRequest is a request to search for address.

```go
type SearchAddressRequest struct {
    Address string `json:"address"`
}
```

## type [SearchAddressResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L30-L32>)

SearchAddressResponse is a response for address search.

```go
type SearchAddressResponse struct {
    Addresses []string `json:"addresses"`
}
```

## type [SearchBlockRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L53-L55>)

SearchBlockRequest is a request to search for block.

```go
type SearchBlockRequest struct {
    RawTrxHash [32]byte `json:"raw_trx_hash"`
}
```

## type [SearchBlockResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L58-L60>)

SearchBlockResponse is a response for block search.

```go
type SearchBlockResponse struct {
    RawBlockHash [32]byte `json:"raw_block_hash"`
}
```

## type [TransactionConfirmProposeResponse](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L88-L91>)

TransactionConfirmProposeResponse is a response for transaction propose.

```go
type TransactionConfirmProposeResponse struct {
    Success bool     `json:"success"`
    TrxHash [32]byte `json:"trx_hash"`
}
```

## type [TransactionProposeRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/rest.go#L82-L85>)

TransactionProposeRequest is a request to propose a transaction.

```go
type TransactionProposeRequest struct {
    ReceiverAddr string                  `json:"receiver_addr"`
    Transaction  transaction.Transaction `json:"transaction"`
}
```

## type [UpgradeConnectionRequest](<https://github.com/bartossh/The-Accountant/blob/main/server/ws.go#L33-L39>)

UpgradeConnectionRequest is a request to upgrade to websocket. Request contains signed Data previously sent to client. Signature verifies if given Address is paired with private key that was used to sign the data.

```go
type UpgradeConnectionRequest struct {
    Address   string   `json:"address"`
    Token     string   `json:"token"`
    Data      []byte   `json:"data"`
    Hash      [32]byte `json:"hash"`
    Signature []byte   `json:"signature"`
}
```

# transaction

```go
import "github.com/bartossh/The-Accountant/transaction"
```

## Index

- [type Signer](<#type-signer>)
- [type Transaction](<#type-transaction>)
  - [func New(subject string, message []byte, issuer Signer) (Transaction, error)](<#func-new>)
  - [func (t *Transaction) Sign(receiver Signer, v Verifier) ([32]byte, error)](<#func-transaction-sign>)
- [type Verifier](<#type-verifier>)


## type [Signer](<https://github.com/bartossh/The-Accountant/blob/main/transaction/transaction.go#L15-L18>)

Signer is an interface for signing transaction.

```go
type Signer interface {
    Sign(message []byte) (digest [32]byte, signature []byte)
    Address() string
}
```

## type [Transaction](<https://github.com/bartossh/The-Accountant/blob/main/transaction/transaction.go#L26-L36>)

Transaction contains transaction information, subject type, subject data, signatures and public keys.

```go
type Transaction struct {
    ID                primitive.ObjectID `json:"-"                  bson:"_id"`
    CreatedAt         time.Time          `json:"created_at"         bson:"created_at"`
    Hash              [32]byte           `json:"hash"               bson:"hash"`
    IssuerAddress     string             `json:"issuer_address"     bson:"issuer_address"`
    ReceiverAddress   string             `json:"receiver_address"   bson:"receiver_address"`
    Subject           string             `json:"subject"            bson:"subcject"`
    Data              []byte             `json:"data"               bson:"data"`
    IssuerSignature   []byte             `json:"issuer_signature"   bson:"issuer_signature"`
    ReceiverSignature []byte             `json:"receiver_signature" bson:"receiver_signature"`
}
```

### func [New](<https://github.com/bartossh/The-Accountant/blob/main/transaction/transaction.go#L39>)

```go
func New(subject string, message []byte, issuer Signer) (Transaction, error)
```

New creates new transaction signed by issuer.

### func \(\*Transaction\) [Sign](<https://github.com/bartossh/The-Accountant/blob/main/transaction/transaction.go#L60>)

```go
func (t *Transaction) Sign(receiver Signer, v Verifier) ([32]byte, error)
```

Sign verifies issuer signature and signs Transaction by receiver.

## type [Verifier](<https://github.com/bartossh/The-Accountant/blob/main/transaction/transaction.go#L21-L23>)

Verifier is an interface for verifying transaction.

```go
type Verifier interface {
    Verify(message, signature []byte, hash [32]byte, address string) error
}
```

# wallet

```go
import "github.com/bartossh/The-Accountant/wallet"
```

## Index

- [type Helper](<#type-helper>)
  - [func (h Helper) AddressToPubKey(address string) (ed25519.PublicKey, error)](<#func-helper-addresstopubkey>)
  - [func (h Helper) Verify(message, signature []byte, hash [32]byte, address string) error](<#func-helper-verify>)
- [type Wallet](<#type-wallet>)
  - [func DecodeGOBWallet(data []byte) (Wallet, error)](<#func-decodegobwallet>)
  - [func New() (Wallet, error)](<#func-new>)
  - [func (w *Wallet) Address() string](<#func-wallet-address>)
  - [func (w *Wallet) ChecksumLength() int](<#func-wallet-checksumlength>)
  - [func (w *Wallet) EncodeGOB() ([]byte, error)](<#func-wallet-encodegob>)
  - [func (w *Wallet) Sign(message []byte) (digest [32]byte, signature []byte)](<#func-wallet-sign>)
  - [func (w *Wallet) Verify(message, signature []byte, hash [32]byte) bool](<#func-wallet-verify>)
  - [func (w *Wallet) Version() byte](<#func-wallet-version>)


## type [Helper](<https://github.com/bartossh/The-Accountant/blob/main/wallet/verifier.go#L13>)

Helper provides wallet helper functionalities without knowing about wallet private and public keys.

```go
type Helper struct{}
```

### func \(Helper\) [AddressToPubKey](<https://github.com/bartossh/The-Accountant/blob/main/wallet/verifier.go#L16>)

```go
func (h Helper) AddressToPubKey(address string) (ed25519.PublicKey, error)
```

AddressToPubKey creates ED25519 public key from address, or returns error otherwise.

### func \(Helper\) [Verify](<https://github.com/bartossh/The-Accountant/blob/main/wallet/verifier.go#L37>)

```go
func (h Helper) Verify(message, signature []byte, hash [32]byte, address string) error
```

Verify verifies if message is signed by given key and hash is equal.

## type [Wallet](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L20-L23>)

Wallet holds public and private key of the wallet owner.

```go
type Wallet struct {
    Private ed25519.PrivateKey `json:"private" bson:"private"`
    Public  ed25519.PublicKey  `json:"public" bson:"public"`
}
```

### func [DecodeGOBWallet](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L35>)

```go
func DecodeGOBWallet(data []byte) (Wallet, error)
```

DecodeGOBWallet tries to decode Wallet from gob representation or returns error otherwise.

### func [New](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L26>)

```go
func New() (Wallet, error)
```

New tries to creates a new Wallet or returns error otherwise.

### func \(\*Wallet\) [Address](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L70>)

```go
func (w *Wallet) Address() string
```

Address creates address from the public key that contains wallet version and checksum.

### func \(\*Wallet\) [ChecksumLength](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L60>)

```go
func (w *Wallet) ChecksumLength() int
```

ChecksumLength returns checksum length.

### func \(\*Wallet\) [EncodeGOB](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L47>)

```go
func (w *Wallet) EncodeGOB() ([]byte, error)
```

EncodeGOB tries to encodes Wallet in to the gob representation or returns error otherwise.

### func \(\*Wallet\) [Sign](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L82>)

```go
func (w *Wallet) Sign(message []byte) (digest [32]byte, signature []byte)
```

Signe signs the message with Ed25519 signature. Returns digest hash sha256 and signature.

### func \(\*Wallet\) [Verify](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L90>)

```go
func (w *Wallet) Verify(message, signature []byte, hash [32]byte) bool
```

Verify verifies message ED25519 signature and hash. Uses hashing sha256.

### func \(\*Wallet\) [Version](<https://github.com/bartossh/The-Accountant/blob/main/wallet/wallet.go#L65>)

```go
func (w *Wallet) Version() byte
```

Version returns wallet version.

# central

```go
import "github.com/bartossh/The-Accountant/cmd/central"
```

## Index





Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
